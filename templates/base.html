<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Plataforma NUAM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background-color: #f5f7fb; }
    footer { background-color: #0b2f53; color: white; }

    .navbar { background-color: #0b2f53; }
    .navbar-brand, .nav-link, .navbar-text { color: white !important; }

    .nav-link.active {
      font-weight: 700;
      text-decoration: underline;
      text-underline-offset: 6px;
    }

    /* Ícono hamburguesa visible en navbar oscuro */
    .navbar-dark .navbar-toggler { border-color: rgba(255,255,255,.35); }
    .navbar-dark .navbar-toggler-icon { filter: invert(1) grayscale(100%); }

    /* Usuario/rol: no rompe línea */
    .user-info { white-space: nowrap; }

    /* --- FIX PRINCIPAL: que el menú no se salga --- */
    /* En pantallas grandes reducimos padding y tamaño para que entre */
    @media (min-width: 992px) {
      .navbar-nav .nav-link {
        padding-left: .55rem;
        padding-right: .55rem;
        font-size: .97rem;
      }
      .navbar-brand { margin-right: .75rem; }
    }

    /* Si aun así no cabe, permitimos scroll horizontal SOLO en la barra de links */
    @media (min-width: 992px) {
      .nav-scroll {
        overflow-x: auto;
        overflow-y: hidden;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
      }
      .nav-scroll::-webkit-scrollbar { height: 6px; }
      .nav-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,.25); border-radius: 8px; }
    }
  </style>
</head>

<body>

{% if request.user.is_authenticated %}
  {% with rol=request.user.rol.nombre|default:'' %}
    {% if rol == "Administrador" or rol == "Gerente" %}
      {% url 'dashboard' as home_url %}
    {% else %}
      {% url 'listar_calificaciones' as home_url %}
    {% endif %}
  {% endwith %}
{% else %}
  {% url 'login' as home_url %}
{% endif %}

<!-- CAMBIO: navbar-expand-xl (colapsa antes que lg, así no se “sale” en ancho medio) -->
<nav class="navbar navbar-expand-xl navbar-dark">
  <div class="container-fluid">

    <a class="navbar-brand fw-bold" href="{{ home_url }}">NUAM</a>

    <!-- Botón hamburguesa -->
    <button class="navbar-toggler" type="button"
            data-bs-toggle="collapse" data-bs-target="#menu"
            aria-controls="menu" aria-expanded="false" aria-label="Menú">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="menu">

      <!-- Menú izquierdo -->
      <!-- CAMBIO: agregamos nav-scroll para que si no cabe, haga scroll horizontal en desktop -->
      <ul class="navbar-nav me-auto mb-2 mb-xl-0 nav-scroll">

        {% if request.user.is_authenticated %}
          {% with rol=request.user.rol.nombre|default:'' %}

            {% if rol == "Administrador" or rol == "Gerente" %}
              <li class="nav-item">
                <a class="nav-link {% if 'dashboard' in request.path %}active{% endif %}"
                   href="{% url 'dashboard' %}">
                  Dashboard
                </a>
              </li>
            {% endif %}

            {% if rol == "Administrador" or rol == "Analista" or rol == "Corredor" or rol == "Auditor" or rol == "Gerente" %}
              <li class="nav-item">
                <a class="nav-link {% if 'calificaciones' in request.path %}active{% endif %}"
                   href="{% url 'listar_calificaciones' %}">
                  Calificaciones
                </a>
              </li>
            {% endif %}

            {% if rol == "Administrador" or rol == "Analista" or rol == "Corredor" %}
              <li class="nav-item">
                <a class="nav-link {% if 'subir-archivo' in request.path %}active{% endif %}"
                   href="{% url 'subir_archivo' %}">
                  Subir archivo
                </a>
              </li>
            {% endif %}

            {% if rol == "Administrador" or rol == "Analista" or rol == "Corredor" %}
              <li class="nav-item">
                <a class="nav-link {% if 'subir-pdf' in request.path %}active{% endif %}"
                   href="{% url 'subir_pdf' %}">
                  Subir PDF
                </a>
              </li>
            {% endif %}

            {% if rol == "Administrador" or rol == "Auditor" %}
              <li class="nav-item">
                <a class="nav-link {% if 'bitacora' in request.path %}active{% endif %}"
                   href="{% url 'ver_bitacora' %}">
                  Bitácora
                </a>
              </li>
            {% endif %}

            {% if rol == "Administrador" or rol == "Auditor" %}
              <li class="nav-item">
                <a class="nav-link {% if 'reportes' in request.path %}active{% endif %}"
                   href="{% url 'reporte_calificaciones' %}">
                  Reportes
                </a>
              </li>
            {% endif %}

            {% if rol == "Administrador" or rol == "Analista" or rol == "Corredor" or rol == "Auditor" or rol == "Gerente" %}
              <li class="nav-item">
                <a class="nav-link {% if 'notificaciones' in request.path %}active{% endif %}"
                   href="{% url 'ver_notificaciones' %}">
                  Notificaciones
                </a>
              </li>
            {% endif %}

            {% if rol == "Administrador" %}
              <li class="nav-item">
                <a class="nav-link {% if 'informe-gestion' in request.path %}active{% endif %}"
                   href="{% url 'informe_gestion_pdf' %}">
                  Informe de gestión (PDF)
                </a>
              </li>
            {% endif %}

            {% if rol == "Administrador" %}
              <li class="nav-item">
                <a class="nav-link {% if 'crear-usuario' in request.path %}active{% endif %}"
                   href="{% url 'crear_usuario' %}">
                  Crear usuario
                </a>
              </li>
            {% endif %}

          {% endwith %}
        {% endif %}

      </ul>

      <!-- Lado derecho -->
      {% if request.user.is_authenticated %}
        <div class="d-flex align-items-center gap-3 ms-xl-3">
          <span class="navbar-text user-info">
            {{ request.user.username }}
            {% if request.user.rol %}
              <small class="ms-1">({{ request.user.rol.nombre }})</small>
            {% endif %}
          </span>

          <form method="post" action="{% url 'logout' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-light btn-sm">
              Cerrar sesión
            </button>
          </form>
        </div>
      {% else %}
        <a href="{% url 'login' %}" class="btn btn-outline-light btn-sm">
          Iniciar sesión
        </a>
      {% endif %}

    </div>
  </div>
</nav>

<main class="container my-4">
  {% block content %}{% endblock %}
</main>

<footer class="text-center py-3 mt-4">
  Plataforma NUAM • Sistema de Calificaciones Tributarias © 2025
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
